<div class="relative flex min-w-0 flex-auto flex-col overflow-hidden">
	<!-- Header & Cards -->
	<div class="relative overflow-hidden px-6 pb-12 pt-8 sm:px-16 sm:pb-24 sm:pt-20">
		<!-- Background -->
		<!-- prettier-ignore -->
		<svg class="-z-1 absolute inset-0"
			 viewBox="0 0 960 540" width="100%" height="100%" preserveAspectRatio="xMidYMax slice" xmlns="http://www.w3.org/2000/svg">
			<g class="opacity-40 text-gray-200 dark:text-gray-800" fill="none" stroke="currentColor" stroke-width="100">
				<circle r="234" cx="196" cy="23"></circle>
				<circle r="234" cx="790" cy="491"></circle>
			</g>
		</svg>

		<!-- Header -->
		<div class="flex flex-col items-center">
			<h2 class="text-xl font-semibold">SUBSCRIPTION PLANS</h2>
			<div class="mt-1 text-center text-4xl font-extrabold leading-tight tracking-tight sm:text-7xl">Choose your perfect plan</div>
			<div class="text-secondary mt-3 text-center tracking-tight sm:text-2xl">
				<div>Upgrade or downgrade your current plan.</div>
				<div>Take control of your productivity.</div>
			</div>
		</div>

		<!-- Loading State -->
		@if (loading) {
			<div class="mt-8 flex justify-center">
				<mat-icon class="animate-spin">refresh</mat-icon>
				<span class="ml-2">Loading plans...</span>
			</div>
		}

		<!-- Error State -->
		@if (error) {
			<div class="mt-8">
				<fuse-alert [appearance]="'outline'" [type]="'error'">
					{{ error }}
				</fuse-alert>
			</div>
		}

		<!-- Plans Grid -->
		@if (!loading && !error && plans.length > 0) {
			<!-- Cards -->
			<div class="mt-10 flex justify-center sm:mt-20">
				<div class="w-full max-w-sm md:max-w-5xl">
					<div class="grid grid-cols-1 gap-8 md:grid-cols-2">
						@for (plan of plans; track trackByFn($index, plan)) {
							<fuse-card
								class="relative flex flex-col overflow-hidden transition-all duration-300 hover:shadow-xl cursor-pointer"
								[ngClass]="{
									'ring-4 ring-primary': isPlanSelected(plan.id),
									'hover:ring-2 hover:ring-primary/50': !isPlanSelected(plan.id),
								}"
								(click)="selectPlan(plan.id)"
							>
								<!-- Card Content -->
								<div class="flex flex-col h-full p-10">
									<!-- Plan Name -->
									<div class="text-4xl font-bold leading-tight tracking-tight text-center">
										{{ getPlanDisplayName(plan.metadata.zelfPlan) }}
									</div>

									<!-- Plan Description -->
									<div class="text-secondary mt-4 text-center text-base leading-relaxed">
										{{ plan.description || plan.name }}
									</div>

									<!-- Accent Line -->
									<div class="my-6 h-1 w-12 rounded bg-accent mx-auto"></div>

									<!-- Price -->
									@if (getCheapestPrice(plan)) {
										<div class="flex items-baseline whitespace-nowrap justify-center">
											<div class="mr-2 text-2xl">{{ getCheapestPrice(plan)!.currency.toUpperCase() }}</div>
											<div class="text-6xl font-semibold leading-tight tracking-tight">
												{{ formatPrice(getCheapestPrice(plan)!.unit_amount, getCheapestPrice(plan)!.currency) }}
											</div>
										</div>

										<!-- Price details -->
										<div class="text-secondary mt-2 text-center">
											<div>{{ getCheapestPrice(plan)!.recurring.interval }} billing</div>
										</div>
									} @else {
										<div class="text-6xl font-semibold leading-tight tracking-tight text-center">Contact</div>
									}

									<!-- Features -->
									<div class="mt-8 flex flex-col">
										<div class="font-semibold">
											@if (plan.metadata.zelfPlan === "zelfBasic") {
												Core features, including:
											} @else if (plan.metadata.zelfPlan === "zelfGold") {
												Personal features, plus:
											} @else {
												Premium features, plus:
											}
										</div>
										<div class="mt-4 space-y-2">
											<!-- Active Users -->
											<div class="flex">
												<mat-icon class="text-green-600 icon-size-5" [svgIcon]="'heroicons_solid:check'"></mat-icon>
												<div class="ml-2 leading-5">
													@if (plan.metadata.zelfPlan === "zelfBasic") {
														<b>50</b> active users
													} @else if (plan.metadata.zelfPlan === "zelfStartUp") {
														<b>500</b> active users
													} @else if (plan.metadata.zelfPlan === "zelfBusiness") {
														<b>1,250</b> active users
													} @else if (plan.metadata.zelfPlan === "zelfGold") {
														<b>3,000</b> active users
													} @else if (plan.metadata.zelfPlan === "zelfEnterprise") {
														<b>10,000</b> active users
													} @else {
														<b>Unlimited</b> active users
													}
												</div>
											</div>

											<!-- Encryption Limit -->
											<div class="flex">
												<mat-icon class="text-green-600 icon-size-5" [svgIcon]="'heroicons_solid:check'"></mat-icon>
												<div class="ml-2 leading-5">
													@if (plan.metadata.zelfPlan === "zelfBasic") {
														<b>50</b> encryptions/month
													} @else {
														<b>Unlimited</b> encryptions
													}
												</div>
											</div>

											<!-- Priority Support -->
											@if (plan.metadata.zelfPlan !== "zelfBasic" && plan.metadata.zelfPlan !== "zelfStartUp") {
												<div class="flex">
													<mat-icon class="text-green-600 icon-size-5" [svgIcon]="'heroicons_solid:check'"></mat-icon>
													<div class="ml-2 leading-5">Priority support</div>
												</div>
											}

											<!-- Dedicated Infrastructure -->
											@if (plan.metadata.zelfPlan === "zelfEnterprise") {
												<div class="flex">
													<mat-icon class="text-green-600 icon-size-5" [svgIcon]="'heroicons_solid:check'"></mat-icon>
													<div class="ml-2 leading-5"><b>Dedicated</b> infrastructure</div>
												</div>
											}

											<!-- Additional Features -->
											@if (
												plan.metadata.zelfPlan === "zelfGold" ||
												plan.metadata.zelfPlan === "zelfBusiness" ||
												plan.metadata.zelfPlan === "zelfEnterprise"
											) {
												<div class="flex">
													<mat-icon class="text-green-600 icon-size-5" [svgIcon]="'heroicons_solid:check'"></mat-icon>
													<div class="ml-2 leading-5">Advanced analytics</div>
												</div>
											}

											@if (plan.metadata.zelfPlan === "zelfEnterprise") {
												<div class="flex">
													<mat-icon class="text-green-600 icon-size-5" [svgIcon]="'heroicons_solid:check'"></mat-icon>
													<div class="ml-2 leading-5">24/7 support</div>
												</div>
											}
										</div>
									</div>
								</div>
							</fuse-card>
						}
					</div>
				</div>
			</div>
		}

		<!-- No Plans State -->
		@if (!loading && !error && plans.length === 0) {
			<div class="mt-8 text-center text-secondary">No subscription plans available.</div>
		}

		<!-- Hidden Form for Data Binding -->
		@if (!loading && !error && plans.length > 0) {
			<form [formGroup]="planBillingForm" class="hidden">
				<input [formControlName]="'plan'" type="hidden" />
			</form>
		}

		<!-- Actions -->
		@if (!loading && !error && plans.length > 0) {
			<div class="mt-8 flex items-center justify-center">
				<button
					mat-flat-button
					type="button"
					[color]="'primary'"
					class="px-12 py-3 text-lg font-semibold bg-primary text-white"
					[disabled]="!planBillingForm.get('plan')?.value || subscribing"
					(click)="onSubscribe()"
				>
					@if (subscribing) {
						<mat-icon class="animate-spin mr-2">refresh</mat-icon>
						Creating Checkout Session...
					} @else if (hasSubscription) {
						Save Changes
					} @else {
						Subscribe
					}
				</button>
			</div>
		}
	</div>
</div>
