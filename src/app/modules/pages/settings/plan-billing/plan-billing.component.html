<div class="flex flex-col min-h-screen bg-gray-50/50 dark:bg-gray-900 w-full">
	<!-- Main Content Container -->
	<!-- Main Content Container -->
	<div class="flex-auto p-6 sm:p-10 w-full max-w-screen-xl">
		<!-- Authentication/Loading State -->
		@if (initialLoading) {
			<div class="flex flex-col items-center justify-center min-h-[400px]">
				<mat-icon class="animate-spin text-5xl text-blue-600 mb-4">refresh</mat-icon>
				<div class="text-xl font-semibold text-gray-800 dark:text-gray-200">
					{{ "saving_operations.plan_billing_page.loading_title" | transloco }}
				</div>
				<div class="text-gray-500 mt-2">{{ "saving_operations.plan_billing_page.loading_description" | transloco }}</div>
			</div>
		}

		<!-- Error State -->
		@if (error) {
			<div class="mb-6 animate-fade-in">
				<div
					class="bg-red-50 border border-red-200 text-red-800 rounded-2xl p-4 flex items-center gap-3 dark:bg-red-900/20 dark:border-red-800 dark:text-red-300"
				>
					<mat-icon class="icon-size-5">error_outline</mat-icon>
					<span class="font-medium">{{ error }}</span>
				</div>
			</div>
		}

		@if (!initialLoading && !error) {
			<!-- Active Subscription Card -->
			@if (hasSubscription && getCurrentPlan()) {
				<div class="bg-gradient-to-br from-indigo-600 to-violet-700 rounded-3xl shadow-xl overflow-hidden mb-8 text-white relative">
					<!-- Geometric Background Pattern -->
					<div class="absolute inset-0 opacity-10">
						<svg class="h-full w-full" viewBox="0 0 100 100" preserveAspectRatio="none">
							<path d="M0 100 C 20 0 50 0 100 100 Z" fill="white" />
						</svg>
					</div>

					<div class="p-8 sm:p-10 relative z-10">
						<div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
							<div>
								<div class="flex items-center gap-3 mb-2">
									<span
										class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-sm font-bold border border-white/20 uppercase tracking-wider"
									>
										{{ getCurrentSubscription().status }}
									</span>
									<span class="text-indigo-200 text-sm font-medium">{{
										"saving_operations.plan_billing_page.active_subscription.title" | transloco
									}}</span>
								</div>
								<h3 class="text-4xl font-extrabold mb-2">{{ getCurrentPlan().name }}</h3>
								<p class="text-indigo-100 text-lg max-w-xl">{{ getCurrentPlan().description }}</p>
							</div>

							<div class="text-left md:text-right bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/10">
								<div class="text-5xl font-bold mb-1">
									{{ formatPrice(getCurrentSubscription().plan.amount, getCurrentSubscription().plan.currency) }}
								</div>
								<div class="text-indigo-200 font-medium">
									{{ "saving_operations.plan_billing_page.active_subscription.per" | transloco }}
									{{ getCurrentSubscription().plan.interval }}
								</div>
							</div>
						</div>

						<div class="h-px bg-white/20 my-8"></div>

						<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
							<!-- Subscription Details -->
							<div>
								<h4 class="text-sm font-bold uppercase tracking-wider text-indigo-200 mb-4">
									{{ "saving_operations.plan_billing_page.details.title" | transloco }}
								</h4>
								<div class="space-y-3">
									<div class="flex justify-between items-center group">
										<span class="text-indigo-100">{{
											"saving_operations.plan_billing_page.details.next_billing" | transloco
										}}</span>
										<span class="font-bold border-b border-dashed border-white/30">{{
											formatDate(getCurrentSubscription().current_period_end)
										}}</span>
									</div>
									<div class="flex justify-between items-center group">
										<span class="text-indigo-100">{{
											"saving_operations.plan_billing_page.details.current_period" | transloco
										}}</span>
										<span class="font-medium bg-white/10 px-2 py-0.5 rounded text-sm">
											{{ formatDate(getCurrentSubscription().current_period_start) }} -
											{{ formatDate(getCurrentSubscription().current_period_end) }}
										</span>
									</div>
									<div class="flex justify-between items-center group">
										<span class="text-indigo-100">{{
											"saving_operations.plan_billing_page.details.subscription_id" | transloco
										}}</span>
										<span class="font-mono text-sm opacity-70">{{ getCurrentSubscription().id }}</span>
									</div>
								</div>
							</div>

							<!-- Quick Actions -->
							<div>
								<h4 class="text-sm font-bold uppercase tracking-wider text-indigo-200 mb-4">
									{{ "saving_operations.plan_billing_page.actions.title" | transloco }}
								</h4>
								<div class="flex flex-wrap gap-3">
									<button
										mat-flat-button
										class="bg-white text-indigo-900 hover:bg-gray-100 font-bold rounded-xl px-6 py-3 border-0 shadow-lg transition-transform active:scale-95"
										(click)="openStripePortal()"
									>
										<mat-icon class="mr-2">payment</mat-icon>
										{{ "saving_operations.plan_billing_page.actions.manage_billing" | transloco }}
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Plan Usage Stats (Optional, if we want to show limits from IPFS) -->
				@if (mySubscription?.subscriptionIPFS?.limits) {
					<div class="bg-white dark:bg-slate-800 rounded-3xl shadow-xl overflow-hidden mb-8 border border-gray-100 dark:border-gray-700/50">
						<div class="p-8 sm:p-10">
							<div class="flex items-center gap-3 mb-6">
								<div
									class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400"
								>
									<mat-icon class="icon-size-5">bar_chart</mat-icon>
								</div>
								<div>
									<h2 class="text-xl font-bold text-gray-900 dark:text-white">
										{{ "saving_operations.plan_billing_page.limits.title" | transloco }}
									</h2>
									<p class="text-sm text-gray-500 dark:text-gray-400">
										{{ "saving_operations.plan_billing_page.limits.subtitle" | transloco }}
									</p>
								</div>
							</div>

							<div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
								<div class="bg-gray-50 dark:bg-gray-900/50 rounded-2xl p-5 border border-gray-100 dark:border-gray-800">
									<div class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">
										{{ "saving_operations.plan_billing_page.limits.tags" | transloco }}
									</div>
									<div class="text-2xl font-bold text-gray-900 dark:text-white">
										{{ mySubscription.subscriptionIPFS.limits.tags || 0 }}
									</div>
								</div>
								<div class="bg-gray-50 dark:bg-gray-900/50 rounded-2xl p-5 border border-gray-100 dark:border-gray-800">
									<div class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">
										{{ "saving_operations.plan_billing_page.limits.zelfkeys" | transloco }}
									</div>
									<div class="text-2xl font-bold text-gray-900 dark:text-white">
										{{ mySubscription.subscriptionIPFS.limits.zelfkeys || 0 }}
									</div>
								</div>
								<div class="bg-gray-50 dark:bg-gray-900/50 rounded-2xl p-5 border border-gray-100 dark:border-gray-800">
									<div class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">
										{{ "saving_operations.plan_billing_page.limits.zelfproofs" | transloco }}
									</div>
									<div class="text-2xl font-bold text-gray-900 dark:text-white">
										{{ mySubscription.subscriptionIPFS.limits.zelfProofs || 0 }}
									</div>
								</div>
							</div>
						</div>
					</div>
				}
			}

			<!-- Available Plans (If no subscription or for upgrades) -->
			@if (!hasSubscription || (hasSubscription && showPlanComparison)) {
				<div class="mb-8">
					@if (hasSubscription) {
						<div class="flex items-center justify-between mb-6">
							<h3 class="text-2xl font-bold text-gray-900 dark:text-white">
								{{ "saving_operations.plan_billing_page.available_upgrades.title" | transloco }}
							</h3>
							<button mat-button color="warn" (click)="hidePlanComparison()">
								<mat-icon>close</mat-icon> {{ "saving_operations.plan_billing_page.available_upgrades.cancel" | transloco }}
							</button>
						</div>
					} @else {
						<h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
							{{ "saving_operations.plan_billing_page.select_plan" | transloco }}
						</h3>
					}

					<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
						@for (plan of hasSubscription ? getUpgradePlans() : plans; track trackByFn($index, plan)) {
							<div
								class="bg-white dark:bg-slate-800 rounded-3xl shadow-lg border-2 border-transparent hover:border-blue-300 transition-all duration-300 relative overflow-hidden group flex flex-col"
							>
								<div class="p-8 flex-1">
									<h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2">
										{{ getPlanDisplayName(plan.metadata.zelfPlan) }}
									</h4>
									<p class="text-gray-500 dark:text-gray-400 text-sm mb-6 min-h-[40px]">{{ plan.description || plan.name }}</p>

									@if (getCheapestPrice(plan)) {
										<div class="flex items-baseline mb-6">
											<span class="text-4xl font-extrabold text-gray-900 dark:text-white">
												{{ formatPrice(getCheapestPrice(plan)!.unit_amount, getCheapestPrice(plan)!.currency) }}
											</span>
											<span class="text-gray-500 ml-2">/ {{ getCheapestPrice(plan)!.recurring.interval }}</span>
										</div>
									}

									<!-- Features List -->
									<div class="space-y-3 mb-8">
										@if (plan.metadata.zelfPlan === "zelfBasic") {
											<div class="flex items-start gap-3">
												<mat-icon class="text-green-500 icon-size-5 shrink-0">check_circle</mat-icon>
												<span class="text-sm text-gray-600 dark:text-gray-300"
													><b>50</b> {{ "saving_operations.plan_billing_page.features.active_users" | transloco }}</span
												>
											</div>
											<div class="flex items-start gap-3">
												<mat-icon class="text-green-500 icon-size-5 shrink-0">check_circle</mat-icon>
												<span class="text-sm text-gray-600 dark:text-gray-300"
													><b>50</b> {{ "saving_operations.plan_billing_page.features.encryptions_mo" | transloco }}</span
												>
											</div>
										} @else if (plan.metadata.zelfPlan === "zelfStartUp") {
											<div class="flex items-start gap-3">
												<mat-icon class="text-green-500 icon-size-5 shrink-0">check_circle</mat-icon>
												<span class="text-sm text-gray-600 dark:text-gray-300"
													><b>500</b> {{ "saving_operations.plan_billing_page.features.active_users" | transloco }}</span
												>
											</div>
											<div class="flex items-start gap-3">
												<mat-icon class="text-green-500 icon-size-5 shrink-0">check_circle</mat-icon>
												<span class="text-sm text-gray-600 dark:text-gray-300"
													><b>{{ "saving_operations.plan_billing_page.features.unlimited" | transloco }}</b>
													{{ "saving_operations.plan_billing_page.features.encryptions" | transloco }}</span
												>
											</div>
										} @else if (plan.metadata.zelfPlan === "zelfBusiness") {
											<div class="flex items-start gap-3">
												<mat-icon class="text-green-500 icon-size-5 shrink-0">check_circle</mat-icon>
												<span class="text-sm text-gray-600 dark:text-gray-300"
													><b>1,250</b> {{ "saving_operations.plan_billing_page.features.active_users" | transloco }}</span
												>
											</div>
											<div class="flex items-start gap-3">
												<mat-icon class="text-green-500 icon-size-5 shrink-0">check_circle</mat-icon>
												<span class="text-sm text-gray-600 dark:text-gray-300">{{
													"saving_operations.plan_billing_page.features.priority_support" | transloco
												}}</span>
											</div>
										} @else if (plan.metadata.zelfPlan === "zelfGold") {
											<div class="flex items-start gap-3">
												<mat-icon class="text-green-500 icon-size-5 shrink-0">check_circle</mat-icon>
												<span class="text-sm text-gray-600 dark:text-gray-300"
													><b>3,000</b> {{ "saving_operations.plan_billing_page.features.active_users" | transloco }}</span
												>
											</div>
											<div class="flex items-start gap-3">
												<mat-icon class="text-green-500 icon-size-5 shrink-0">check_circle</mat-icon>
												<span class="text-sm text-gray-600 dark:text-gray-300">{{
													"saving_operations.plan_billing_page.features.advanced_analytics" | transloco
												}}</span>
											</div>
										} @else if (plan.metadata.zelfPlan === "zelfEnterprise") {
											<div class="flex items-start gap-3">
												<mat-icon class="text-green-500 icon-size-5 shrink-0">check_circle</mat-icon>
												<span class="text-sm text-gray-600 dark:text-gray-300"
													><b>10,000</b> {{ "saving_operations.plan_billing_page.features.users" | transloco }}</span
												>
											</div>
											<div class="flex items-start gap-3">
												<mat-icon class="text-green-500 icon-size-5 shrink-0">check_circle</mat-icon>
												<span class="text-sm text-gray-600 dark:text-gray-300">{{
													"saving_operations.plan_billing_page.features.dedicated_infra" | transloco
												}}</span>
											</div>
										}
									</div>
								</div>

								<div class="p-6 bg-gray-50 dark:bg-gray-900/30 border-t border-gray-100 dark:border-gray-700/50 mt-auto">
									@if (hasSubscription) {
										<button mat-flat-button color="primary" class="w-full rounded-xl py-6" (click)="upgradeToPlan(plan)">
											{{ "saving_operations.plan_billing_page.upgrade" | transloco }}
										</button>
									} @else {
										<button
											mat-flat-button
											color="primary"
											class="w-full rounded-xl py-6 font-bold text-lg"
											[disabled]="subscribing && subscribingPlanId === plan.id"
											(click)="onSubscribe(plan.id)"
										>
											@if (subscribing && subscribingPlanId === plan.id) {
												<mat-icon class="animate-spin mr-2">refresh</mat-icon>
												{{ "saving_operations.plan_billing_page.processing" | transloco }}
											} @else {
												{{ "saving_operations.plan_billing_page.get_started" | transloco }}
											}
										</button>
									}
								</div>
							</div>
						}
					</div>
				</div>
			}

			<!-- Billing History -->
			@if (billingHistory && billingHistory.length > 0) {
				<div class="bg-white dark:bg-slate-800 rounded-3xl shadow-xl overflow-hidden border border-gray-100 dark:border-gray-700/50">
					<div class="p-8">
						<div class="flex items-center justify-between mb-6">
							<h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
								<mat-icon class="text-gray-400">receipt_long</mat-icon>
								{{ "saving_operations.plan_billing_page.billing_history.title" | transloco }}
							</h3>
						</div>

						<div class="divide-y divide-gray-100 dark:divide-gray-800">
							@for (invoice of billingHistory; track invoice.id) {
								<div class="py-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
									<div>
										<div class="font-bold text-gray-900 dark:text-white">{{ invoice.description }}</div>
										<div class="text-sm text-gray-500">{{ formatDate(invoice.date) }} â€¢ {{ invoice.id }}</div>
									</div>
									<div class="flex items-center gap-4">
										<span
											class="px-3 py-1 rounded-full text-xs font-bold uppercase"
											[ngClass]="getStatusBadgeColor(invoice.status)"
										>
											{{ invoice.status }}
										</span>
										<div class="font-bold text-lg">{{ formatPrice(invoice.amount, invoice.currency) }}</div>
									</div>
								</div>
							}
						</div>
					</div>
				</div>
			}
		}
	</div>
</div>
