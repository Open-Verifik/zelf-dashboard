<!-- Biometric Verification Modal Overlay -->
<div
	*ngIf="showBiometricVerification && !showPasskeyPrompt"
	class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 p-4 transition-opacity duration-300"
>
	<div
		class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl transform transition-all scale-100 flex flex-col"
	>
		<!-- Header -->
		<div class="px-6 py-5 flex items-center justify-between shrink-0 border-b border-gray-100 dark:border-gray-800">
			<div class="flex flex-col">
				<h2 class="text-xl font-bold text-gray-900 dark:text-white leading-tight tracking-tight">
					{{ "acceptInvite.faceVerification" | transloco }}
				</h2>
				<div class="flex items-center gap-1.5 mt-1">
					<div
						class="bg-primary-50 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide flex items-center gap-1"
					>
						<mat-icon class="icon-size-3">lock</mat-icon>
						<span>SECURE</span>
					</div>
					<span class="text-xs font-medium text-gray-500 dark:text-gray-400">
						{{ inviteData?.staffEmail || inviteData?.staffName || "Verifying Account" }}
					</span>
				</div>
			</div>
			<button
				mat-icon-button
				(click)="onBiometricCancel()"
				class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 rounded-full transition-colors"
				title="Close"
			>
				<mat-icon class="icon-size-4 text-gray-500 dark:text-gray-400">close</mat-icon>
			</button>
		</div>

		<div class="p-0 pt-4 pb-8 overflow-y-auto flex-1 flex flex-col justify-center items-center w-full">
			<!-- Biometric Component -->
			<app-data-biometrics
				#biometricVerification
				[userData]="inviteData"
				[isModalContext]="true"
				(biometricsSuccess)="onBiometricSuccess($event)"
				(biometricsCancel)="onBiometricCancel()"
			></app-data-biometrics>
		</div>
	</div>
</div>

<!-- Passkey Prompt Modal -->
<app-passkey-prompt-modal *ngIf="showPasskeyPrompt" (onSave)="onPasskeySave()" (onCancel)="onPasskeyCancel()"> </app-passkey-prompt-modal>

<!-- Component Body -->
<div class="absolute inset-0 flex flex-col items-center justify-center min-h-screen bg-[#F3F4F6] dark:bg-[#0F1115] p-4 text-center overflow-auto">
	<!-- Card Container -->
	<div
		class="w-full max-w-[440px] bg-white dark:bg-[#141414] rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-800 overflow-hidden relative z-10"
	>
		<div class="p-8 sm:p-12">
			<!-- Logo (Centered) -->
			<div class="flex justify-center mb-8">
				<div class="w-20 h-20">
					<img src="images/logo/logo.svg" alt="Logo" class="w-full h-full object-contain" />
				</div>
			</div>

			<div class="mb-8" *ngIf="!isLoading && inviteData">
				<h1 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight mb-2">
					{{ "acceptInvite.title" | transloco }}
				</h1>
				<p class="text-base text-gray-500 dark:text-gray-400">
					{{ "acceptInvite.invitedToJoin" | transloco }}
					<span class="font-semibold text-gray-800 dark:text-gray-200">{{ inviteData.ownerCompany }}</span>
				</p>
				<div
					class="mt-2 text-sm text-primary-600 dark:text-primary-400 font-medium bg-primary-50 dark:bg-primary-900/10 py-1 px-3 rounded-full inline-block border border-primary-100 dark:border-primary-800"
				>
					{{ inviteData.role }}
				</div>
			</div>

			<!-- Loading State -->
			<div *ngIf="isLoading" class="flex flex-col items-center justify-center py-12">
				<mat-progress-spinner mode="indeterminate" diameter="40" class="mb-6"></mat-progress-spinner>
				<div class="text-base font-medium text-gray-500 dark:text-gray-400 animate-pulse">
					{{ "acceptInvite.verifyingInvitation" | transloco }}
				</div>
			</div>

			<!-- Error Alert -->
			<fuse-alert class="mb-8 text-left" *ngIf="showAlert" [type]="alert.type" [appearance]="'soft'">
				<div class="break-words text-sm">{{ alert.message }}</div>
			</fuse-alert>

			<!-- Main Form -->
			<div *ngIf="!isLoading && inviteData">
				<form [formGroup]="acceptInviteForm" #acceptInviteNgForm="ngForm" class="space-y-6">
					<div class="text-left group">
						<label
							class="block text-xs font-bold text-gray-500 dark:text-gray-500 uppercase tracking-wider mb-2 ml-1 group-focus-within:text-primary-500 transition-colors"
							>{{ "acceptInvite.createMasterPassword" | transloco }}</label
						>
						<mat-form-field class="w-full fuse-mat-dense rounded-xl" subscriptSizing="dynamic">
							<input matInput type="password" [formControlName]="'masterPassword'" placeholder="••••••••" class="text-lg" />
							<mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">lock</mat-icon>
						</mat-form-field>
					</div>

					<button
						class="w-full py-4 bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md transition-all duration-200 flex items-center justify-center gap-2 mt-4"
						[disabled]="acceptInviteForm.invalid"
						(click)="acceptInvite()"
					>
						<span>{{ "acceptInvite.verifyIdentity" | transloco }}</span>
						<mat-icon class="icon-size-5">arrow_forward</mat-icon>
					</button>
				</form>

				<div class="mt-8 pt-6 border-t border-gray-100 dark:border-gray-800">
					<div class="flex items-center justify-center gap-2 text-xs text-gray-400 dark:text-gray-500">
						<mat-icon class="icon-size-4">verified_user</mat-icon>
						<span>{{ "acceptInvite.biometricsProtected" | transloco }}</span>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Language Selector (Bottom Right) -->
	<div class="fixed bottom-6 right-6 z-20">
		<select
			[value]="currentLanguage"
			(change)="onLanguageChange($event.target.value)"
			class="px-3 py-2 text-sm font-medium text-gray-500 bg-white/80 dark:bg-gray-800/80 backdrop-blur border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:bg-white dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-500 cursor-pointer transition-all"
		>
			@for (lang of availableLanguages; track lang.code) {
				<option [value]="lang.code">{{ lang.flag }} {{ lang.name }}</option>
			}
		</select>
	</div>
</div>
