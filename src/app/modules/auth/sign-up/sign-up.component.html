<!-- Biometric Verification Modal Overlay -->
@if (showBiometricVerification) {
	<div class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 p-4 transition-opacity duration-300">
		<div
			class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl transform transition-all scale-100 flex flex-col"
		>
			<!-- Header -->
			<div class="px-6 py-5 flex items-center justify-between shrink-0">
				<div class="flex flex-col">
					<h2 class="text-xl font-bold text-gray-900 dark:text-white leading-tight tracking-tight">
						{{ "biometricVerification.title" | transloco }}
					</h2>
					<div class="flex items-center gap-1.5 mt-1">
						<div
							class="bg-primary-50 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide flex items-center gap-1"
						>
							<mat-icon class="icon-size-3">lock</mat-icon>
							<span>SECURE</span>
						</div>
						<span class="text-xs font-medium text-gray-500 dark:text-gray-400">
							{{ userData?.email || userData?.phone || ("biometricVerification.newAccount" | transloco) }}
						</span>
					</div>
				</div>
				<button
					mat-icon-button
					(click)="onBiometricCancel()"
					class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 rounded-full transition-colors"
				>
					<mat-icon class="icon-size-4 text-gray-500 dark:text-gray-400">close</mat-icon>
				</button>
			</div>

			<div class="p-0 pt-4 pb-8 overflow-y-auto flex-1 flex flex-col justify-center items-center">
				<!-- Biometric Component -->
				<app-data-biometrics
					#biometricVerification
					[userData]="userData"
					[isModalContext]="true"
					(biometricsSuccess)="onBiometricSuccess($event)"
					(biometricsCancel)="onBiometricCancel()"
				></app-data-biometrics>
			</div>
		</div>
	</div>
}

<!-- Passkey Prompt Modal -->
@if (showPasskeyPrompt) {
	<app-passkey-prompt-modal (onSave)="onPasskeySave()" (onCancel)="onPasskeyCancel()"> </app-passkey-prompt-modal>
}

<div class="flex flex-col items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900 w-full px-4 sm:px-6 py-8">
	<!-- Main Card -->
	<div
		class="w-full max-w-[480px] bg-white dark:bg-gray-800 rounded-3xl shadow-xl overflow-visible border border-gray-100 dark:border-gray-700 relative"
	>
		<div class="p-8 sm:p-10">
			<!-- Logo & Header -->
			<div class="flex flex-col items-center mb-8">
				<div class="w-12 h-12 mb-6">
					<img src="images/logo/logo.svg" alt="Logo" class="w-full h-full" />
				</div>
				<h1 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight">{{ "signUp.title" | transloco }}</h1>
				<div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
					{{ "signUp.alreadyHaveAccount" | transloco }}
					<a class="font-medium text-primary-600 hover:text-primary-500 ml-1 transition-colors" [routerLink]="['/sign-in']">
						{{ "signUp.signIn" | transloco }}
					</a>
				</div>
			</div>

			<!-- Alert -->
			@if (showAlert) {
				<fuse-alert class="mb-6" [appearance]="'soft'" [showIcon]="true" [type]="alert.type" [@shake]="alert.type === 'error'">
					{{ alert.message }}
				</fuse-alert>
			}

			<!-- Sign Up Form -->
			<form [formGroup]="signUpForm" #signUpNgForm="ngForm" class="space-y-4">
				<!-- Name -->
				<div>
					<label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5 ml-1">{{
						"signUp.fullName" | transloco
					}}</label>
					<input
						id="name"
						[formControlName]="'name'"
						class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-gray-900 dark:text-white placeholder-gray-400"
						placeholder="John Doe"
					/>
					@if (signUpForm.get("name").touched && signUpForm.get("name").hasError("required")) {
						<div class="text-red-500 text-xs mt-1 ml-1">{{ "signUp.nameRequired" | transloco }}</div>
					}
				</div>

				<!-- Email -->
				<div>
					<label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5 ml-1">{{
						"signUp.emailAddress" | transloco
					}}</label>
					<input
						id="email"
						[formControlName]="'email'"
						class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-gray-900 dark:text-white placeholder-gray-400"
						placeholder="name@company.com"
					/>
					@if (signUpForm.get("email").touched && signUpForm.get("email").invalid) {
						<div class="text-red-500 text-xs mt-1 ml-1">
							@if (signUpForm.get("email").hasError("required")) {
								{{ "signUp.emailRequired" | transloco }}
							}
							@if (signUpForm.get("email").hasError("email")) {
								{{ "signUp.emailInvalid" | transloco }}
							}
						</div>
					}
				</div>

				<!-- Phone -->
				<div>
					<label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5 ml-1">{{
						"signUp.phoneNumber" | transloco
					}}</label>
					<div class="flex gap-3 relative">
						<!-- Country Code -->
						<div class="w-36 relative">
							<div class="relative">
								<input
									[formControlName]="'countryCode'"
									[(ngModel)]="countryCodeSearchTerm"
									(input)="filterCountryCodes()"
									(focus)="showCountryDropdown = true"
									(blur)="onCountryBlur()"
									placeholder="Search..."
									class="w-full pl-3 pr-8 py-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-gray-900 dark:text-white text-sm"
								/>
								<div class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
									<mat-icon class="icon-size-4">keyboard_arrow_down</mat-icon>
								</div>
							</div>

							<!-- Dropdown -->
							@if (showCountryDropdown && filteredCountryCodes.length > 0) {
								<div
									class="absolute z-50 top-full left-0 w-64 mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl max-h-60 overflow-y-auto transform origin-top-left transition-all"
								>
									@for (country of filteredCountryCodes; track country.code + country.country) {
										<button
											type="button"
											(mousedown)="selectCountryCode(country)"
											class="w-full px-4 py-2.5 text-left hover:bg-gray-50 dark:hover:bg-gray-700/50 flex items-center gap-3 transition-colors border-b last:border-0 border-gray-50 dark:border-gray-700/50"
										>
											<span class="text-lg leading-none">{{ country.flag }}</span>
											<span class="font-mono text-sm font-medium text-primary-600 dark:text-primary-400">{{
												country.code
											}}</span>
											<span class="text-sm text-gray-600 dark:text-gray-300 truncate">{{ country.country }}</span>
										</button>
									}
								</div>
							}
						</div>

						<!-- Phone Number -->
						<div class="flex-1">
							<input
								id="phone"
								type="tel"
								[formControlName]="'phone'"
								class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-gray-900 dark:text-white placeholder-gray-400"
								placeholder="555-0123"
							/>
						</div>
					</div>
					@if (signUpForm.get("phone").touched && signUpForm.get("phone").invalid) {
						<div class="text-red-500 text-xs mt-1 ml-1">
							@if (signUpForm.get("phone").hasError("required")) {
								{{ "signUp.phoneRequired" | transloco }}
							}
							@if (signUpForm.get("phone").hasError("pattern")) {
								{{ "signUp.phonePattern" | transloco }}
							}
						</div>
					}
				</div>

				<!-- Master Password -->
				<div>
					<label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5 ml-1">{{
						"signUp.masterPassword" | transloco
					}}</label>
					<div class="relative">
						<input
							#masterPasswordField
							id="masterPassword"
							type="password"
							[formControlName]="'masterPassword'"
							class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-gray-900 dark:text-white placeholder-gray-400"
							placeholder="••••••••"
						/>
						<button
							type="button"
							class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors p-1"
							(click)="
								masterPasswordField.type === 'password'
									? (masterPasswordField.type = 'text')
									: (masterPasswordField.type = 'password')
							"
						>
							<mat-icon
								class="icon-size-5"
								[svgIcon]="masterPasswordField.type === 'password' ? 'heroicons_solid:eye' : 'heroicons_solid:eye-slash'"
							></mat-icon>
						</button>
					</div>
					@if (signUpForm.get("masterPassword").touched && signUpForm.get("masterPassword").hasError("required")) {
						<div class="text-red-500 text-xs mt-1 ml-1">{{ "signUp.masterPasswordRequired" | transloco }}</div>
					}
				</div>

				<!-- Company -->
				<div class="pb-1">
					<label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5 ml-1">{{
						"signUp.companyName" | transloco
					}}</label>
					<input
						id="company"
						[formControlName]="'company'"
						class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-gray-900 dark:text-white placeholder-gray-400"
						placeholder="Acme Inc."
					/>
					@if (signUpForm.get("company").touched && signUpForm.get("company").hasError("required")) {
						<div class="text-red-500 text-xs mt-1 ml-1">{{ "signUp.companyRequired" | transloco }}</div>
					}
				</div>

				<!-- Agreements -->
				<div class="flex items-start">
					<mat-checkbox [color]="'primary'" [formControlName]="'agreements'" class="custom-checkbox mt-1">
						<span class="text-sm text-gray-600 dark:text-gray-300 ml-1 leading-normal">
							I agree to the
							<a class="text-primary-600 hover:underline" href="https://docs.zelf.world/docs/legal/terms-of-use" target="_blank">{{
								"signUp.terms" | transloco
							}}</a>
							and
							<a class="text-primary-600 hover:underline" href="https://docs.zelf.world/docs/legal/privacy-policy" target="_blank">{{
								"signUp.privacyPolicy" | transloco
							}}</a>
						</span>
					</mat-checkbox>
				</div>

				<!-- Submit Button -->
				<button
					class="w-full py-4 px-6 bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md transition-all duration-200 disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-2 text-lg mt-4"
					type="button"
					[disabled]="signUpForm.disabled"
					(click)="signUp()"
				>
					@if (!signUpForm.disabled) {
						<span>Create Account</span>
						<mat-icon class="icon-size-5">arrow_forward</mat-icon>
					}
					@if (signUpForm.disabled) {
						<mat-progress-spinner [diameter]="24" [mode]="'indeterminate'"></mat-progress-spinner>
					}
				</button>
			</form>

			<!-- Test Utils -->
			@if (!production) {
				<div class="mt-8 flex justify-center">
					<button
						type="button"
						(click)="fillRandomData()"
						class="text-xs font-medium text-gray-400 hover:text-gray-600 flex items-center gap-1 transition-colors"
					>
						<mat-icon class="icon-size-4">casino</mat-icon>
						Fill Random Data
					</button>
				</div>
			}
		</div>
	</div>

	<!-- Language Selector (Bottom Right) -->
	<div class="fixed bottom-6 right-6 z-20">
		<select
			[value]="currentLanguage"
			(change)="onLanguageChange($event.target.value)"
			class="px-3 py-2 text-sm font-medium text-gray-500 bg-white/80 dark:bg-gray-800/80 backdrop-blur border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:bg-white dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-500 cursor-pointer transition-all"
		>
			@for (lang of availableLanguages; track lang.code) {
				<option [value]="lang.code">{{ lang.flag }} {{ lang.name }}</option>
			}
		</select>
	</div>
</div>
