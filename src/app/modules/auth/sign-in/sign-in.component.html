<!-- Biometric Verification Modal Overlay -->
@if (showBiometricVerification) {
	<div class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 p-4 transition-opacity duration-300">
		<div
			class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl transform transition-all scale-100 flex flex-col"
		>
			<!-- Header -->
			<div class="px-6 py-5 flex items-center justify-between shrink-0">
				<div class="flex flex-col">
					<h2 class="text-xl font-bold text-gray-900 dark:text-white leading-tight tracking-tight">
						{{ "biometricVerification.title" | transloco }}
					</h2>
					<div class="flex items-center gap-1.5 mt-1">
						<div
							class="bg-primary-50 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide flex items-center gap-1"
						>
							<mat-icon class="icon-size-3">lock</mat-icon>
							<span>SECURE</span>
						</div>
						<span class="text-xs font-medium text-gray-500 dark:text-gray-400">
							{{ userData?.email || userData?.phone || ("biometricVerification.account" | transloco) }}
						</span>
					</div>
				</div>
				<button
					mat-icon-button
					(click)="onBiometricCancel()"
					class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 rounded-full transition-colors"
				>
					<mat-icon class="icon-size-4 text-gray-500 dark:text-gray-400">close</mat-icon>
				</button>
			</div>

			<div class="p-0 pt-4 pb-8 overflow-y-auto flex-1 flex flex-col justify-center items-center">
				<!-- Biometric Component -->
				<app-data-biometrics
					#biometricVerification
					[userData]="userData"
					[isModalContext]="true"
					(biometricsSuccess)="onBiometricSuccess($event)"
					(biometricsCancel)="onBiometricCancel()"
				></app-data-biometrics>
			</div>
		</div>
	</div>
}

<!-- Passkey Prompt Modal -->
@if (showPasskeyPrompt) {
	<app-passkey-prompt-modal (onSave)="onPasskeySave()" (onCancel)="onPasskeyCancel()"> </app-passkey-prompt-modal>
}

<div class="flex flex-col items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900 w-full px-4 sm:px-6">
	<!-- Main Card -->
	<div class="w-full max-w-[420px] bg-white dark:bg-gray-800 rounded-3xl shadow-xl overflow-hidden border border-gray-100 dark:border-gray-700">
		<div class="p-8 sm:p-10">
			<!-- Logo & Header -->
			<div class="flex flex-col items-center mb-8">
				<div class="w-12 h-12 mb-6">
					<img src="images/logo/logo.svg" alt="Logo" class="w-full h-full" />
				</div>
				<h1 class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight">Welcome back</h1>
				<div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
					{{ "signIn.dontHaveAccount" | transloco }}
					<a class="font-medium text-primary-600 hover:text-primary-500 ml-1 transition-colors" [routerLink]="['/sign-up']">
						{{ "signIn.signUp" | transloco }}
					</a>
				</div>
			</div>

			<!-- Alert -->
			@if (showAlert) {
				<fuse-alert class="mb-6" [appearance]="'soft'" [showIcon]="true" [type]="alert.type" [@shake]="alert.type === 'error'">
					{{ alert.message }}
				</fuse-alert>
			}

			<!-- Sign in form -->
			<form [formGroup]="signInForm" #signInNgForm="ngForm">
				<!-- Method Tabs -->
				<div class="bg-gray-100 dark:bg-gray-700/50 p-1 rounded-xl mb-6 flex">
					<button
						type="button"
						class="flex-1 text-sm font-medium py-2 rounded-lg transition-all duration-200"
						[class.bg-white]="signInForm.get('identificationMethod')?.value === 'email'"
						[class.shadow-sm]="signInForm.get('identificationMethod')?.value === 'email'"
						[class.text-gray-900]="signInForm.get('identificationMethod')?.value === 'email'"
						[class.dark:bg-gray-600]="signInForm.get('identificationMethod')?.value === 'email'"
						[class.dark:text-white]="signInForm.get('identificationMethod')?.value === 'email'"
						[class.text-gray-500]="signInForm.get('identificationMethod')?.value !== 'email'"
						(click)="signInForm.get('identificationMethod')?.setValue('email')"
					>
						Email
					</button>
					<button
						type="button"
						class="flex-1 text-sm font-medium py-2 rounded-lg transition-all duration-200"
						[class.bg-white]="signInForm.get('identificationMethod')?.value === 'phone'"
						[class.shadow-sm]="signInForm.get('identificationMethod')?.value === 'phone'"
						[class.text-gray-900]="signInForm.get('identificationMethod')?.value === 'phone'"
						[class.dark:bg-gray-600]="signInForm.get('identificationMethod')?.value === 'phone'"
						[class.dark:text-white]="signInForm.get('identificationMethod')?.value === 'phone'"
						[class.text-gray-500]="signInForm.get('identificationMethod')?.value !== 'phone'"
						(click)="signInForm.get('identificationMethod')?.setValue('phone')"
					>
						Phone
					</button>
				</div>

				<!-- Email Input -->
				@if (signInForm.get("identificationMethod")?.value === "email") {
					<div class="space-y-4">
						<div class="relative">
							<label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5 ml-1">{{
								"signIn.emailAddress" | transloco
							}}</label>
							<input
								id="email"
								[formControlName]="'email'"
								(blur)="checkPasskey()"
								class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-gray-900 dark:text-white placeholder-gray-400"
								[class.border-red-500]="signInForm.get('email').touched && signInForm.get('email').invalid"
								placeholder="name@company.com"
							/>
							@if (signInForm.get("email").touched && signInForm.get("email").invalid) {
								<div class="text-red-500 text-xs mt-1 ml-1">
									@if (signInForm.get("email").hasError("required")) {
										{{ "signIn.emailRequired" | transloco }}
									}
									@if (signInForm.get("email").hasError("email")) {
										{{ "signIn.emailInvalid" | transloco }}
									}
								</div>
							}
						</div>

						@if (showPasskeyLogin) {
							<button
								type="button"
								class="w-full group flex items-center justify-center gap-2 py-2.5 px-4 bg-primary-50 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400 rounded-xl border border-primary-100 dark:border-primary-800 hover:bg-primary-100 dark:hover:bg-primary-900/30 transition-colors"
								(click)="loginWithPasskey()"
							>
								<mat-icon class="icon-size-5 transition-transform group-hover:scale-110">fingerprint</mat-icon>
								<span class="font-medium">Sign in with Passkey</span>
							</button>
						}
					</div>
				}

				<!-- Phone Input -->
				@if (signInForm.get("identificationMethod")?.value === "phone") {
					<div class="space-y-4">
						<div class="space-y-1.5">
							<label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5 ml-1">{{
								"signIn.phoneNumber" | transloco
							}}</label>
							<div class="flex gap-3">
								<div class="w-32">
									<select
										[formControlName]="'countryCode'"
										class="w-full h-[46px] px-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-gray-900 dark:text-white appearance-none cursor-pointer"
									>
										@for (country of countryCodes; track country.code) {
											<option [value]="country.code">{{ country.flag }} {{ country.code }}</option>
										}
									</select>
								</div>
								<div class="flex-1">
									<input
										id="phone"
										type="tel"
										[formControlName]="'phone'"
										(blur)="checkPasskey()"
										class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-gray-900 dark:text-white placeholder-gray-400"
										placeholder="555-0123"
									/>
								</div>
							</div>
							@if (signInForm.get("phone").touched && signInForm.get("phone").invalid) {
								<div class="text-red-500 text-xs ml-1">
									@if (signInForm.get("phone").hasError("required")) {
										{{ "signIn.phoneRequired" | transloco }}
									}
									@if (signInForm.get("phone").hasError("pattern")) {
										{{ "signIn.phonePattern" | transloco }}
									}
								</div>
							}
						</div>

						@if (showPasskeyLogin) {
							<button
								type="button"
								class="w-full group flex items-center justify-center gap-2 py-2.5 px-4 bg-primary-50 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400 rounded-xl border border-primary-100 dark:border-primary-800 hover:bg-primary-100 dark:hover:bg-primary-900/30 transition-colors"
								(click)="loginWithPasskey()"
							>
								<mat-icon class="icon-size-5 transition-transform group-hover:scale-110">fingerprint</mat-icon>
								<span class="font-medium">Sign in with Passkey</span>
							</button>
						}
					</div>
				}

				<!-- Password Input -->
				<div class="mt-6 mb-6">
					<label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5 ml-1">{{
						"signIn.masterPassword" | transloco
					}}</label>
					<div class="relative">
						<input
							#masterPasswordField
							id="masterPassword"
							type="password"
							[formControlName]="'masterPassword'"
							class="w-full pl-4 pr-12 py-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-gray-900 dark:text-white placeholder-gray-400"
							placeholder="••••••••"
						/>
						<button
							type="button"
							class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors p-1"
							(click)="
								masterPasswordField.type === 'password'
									? (masterPasswordField.type = 'text')
									: (masterPasswordField.type = 'password')
							"
						>
							<mat-icon
								class="icon-size-5"
								[svgIcon]="masterPasswordField.type === 'password' ? 'heroicons_solid:eye' : 'heroicons_solid:eye-slash'"
							></mat-icon>
						</button>
					</div>
					@if (signInForm.get("masterPassword").touched && signInForm.get("masterPassword").hasError("required")) {
						<div class="text-red-500 text-xs mt-1 ml-1">{{ "signIn.masterPasswordRequired" | transloco }}</div>
					}
				</div>

				<!-- Remember Me -->
				<div class="flex items-center mb-8">
					<mat-checkbox [color]="'primary'" [formControlName]="'rememberMe'" class="custom-checkbox">
						<span class="text-sm font-medium text-gray-600 dark:text-gray-300">{{ "signIn.rememberMe" | transloco }}</span>
					</mat-checkbox>
				</div>

				<!-- Submit Button -->
				<button
					class="w-full py-3.5 px-4 bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 active:shadow-md transition-all duration-200 disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-2"
					type="button"
					[disabled]="signInForm.disabled"
					(click)="signIn()"
				>
					@if (!signInForm.disabled) {
						<span>{{ "signIn.signInButton" | transloco }}</span>
						<mat-icon class="icon-size-5">arrow_forward</mat-icon>
					}
					@if (signInForm.disabled) {
						<mat-progress-spinner [diameter]="24" [mode]="'indeterminate'"></mat-progress-spinner>
					}
				</button>
			</form>

			<!-- Terms Footer -->
			<p class="mt-8 text-xs text-center text-gray-400 dark:text-gray-500">
				By signing in, you agree to our
				<a
					class="underline hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
					href="https://docs.zelf.world/docs/legal/terms-of-use"
					target="_blank"
					>{{ "signIn.termsOfUse" | transloco }}</a
				>
				and
				<a
					class="underline hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
					href="https://docs.zelf.world/docs/legal/privacy-policy"
					target="_blank"
					>{{ "signIn.privacyPolicy" | transloco }}</a
				>.
			</p>
		</div>
	</div>

	<!-- Language Selector (Bottom Right) -->
	<div class="fixed bottom-6 right-6 z-20">
		<select
			[value]="currentLanguage"
			(change)="onLanguageChange($event.target.value)"
			class="px-3 py-2 text-sm font-medium text-gray-500 bg-white/80 dark:bg-gray-800/80 backdrop-blur border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:bg-white dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-500 cursor-pointer transition-all"
		>
			@for (lang of availableLanguages; track lang.code) {
				<option [value]="lang.code">{{ lang.flag }} {{ lang.name }}</option>
			}
		</select>
	</div>
</div>
