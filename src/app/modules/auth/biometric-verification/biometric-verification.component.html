<div class="data-biometrics-container" [class.modal-context]="isModalContext">
	<div class="biometrics-content" fxLayout="column" fxLayoutAlign="center center">
		<div
			*ngIf="!camera.isLoading && camera.hasPermissions && !camera.isLowQuality && !hasApiError && !response.isLoading"
			class="camera-container"
			fxLayout="column"
			fxLayoutAlign="center center"
		>
			<!-- Camera View - Much Larger Now -->
			<div class="camera-view" [style.width.px]="camera.dimensions.video.width" [style.height.px]="camera.dimensions.video.height">
				<webcam
					(imageCapture)="processImage($event)"
					(initError)="cameraError($event)"
					[allowCameraSwitch]="false"
					[captureImageData]="true"
					[height]="camera.dimensions.video.height"
					[imageQuality]="1"
					[trigger]="takePicture$"
					[videoOptions]="camera.configuration"
					[width]="camera.dimensions.video.width"
					*ngIf="!response.base64Image"
					#webcam
					mirrorImage="always"
				></webcam>

				<canvas
					[style.height.px]="response.base64Image ? camera.dimensions.result.height : camera.dimensions.video.height"
					[style.width.px]="response.base64Image ? camera.dimensions.result.width : camera.dimensions.video.width"
					#maskResult
					class="face-mask-canvas"
				></canvas>

				<canvas #toSend hidden="true"></canvas>
			</div>

			<!-- Status Messages - Positioned Below Camera -->
			<div class="status-messages" fxLayout="column" fxLayoutAlign="center center">
				<div *ngIf="errorFace && !response.isLoading" class="biometric__error">
					<div class="biometric__error-title">{{ errorFace.title }}</div>
					<div class="biometric__error-subtitle">{{ errorFace.subtitle }}</div>
				</div>

				<div *ngIf="!errorFace && !response.isLoading" class="biometric__instructions">
					<div class="biometric__instruction-title">{{ "biometricVerification.positionFace" | transloco }}</div>
					<div class="biometric__instruction-subtitle">{{ "biometricVerification.lookAtCamera" | transloco }}</div>
				</div>
			</div>

			<!-- Instructions - Compact and Strategic -->
			<div class="compact-instructions">
				<p>{{ "biometricVerification.verifyInstruction" | transloco }}</p>
			</div>
		</div>

		<!-- API Error Display -->
		<div class="api-error-container" fxLayout="column" fxLayoutAlign="center center" *ngIf="hasApiError && !response.isLoading">
			<div class="api-error-card">
				<div class="error-icon">⚠️</div>
				<h3 class="error-title">{{ "biometricVerification.verificationFailed" | transloco }}</h3>
				<p class="error-message">{{ apiError }}</p>
				<div class="error-actions">
					<button class="btn-retry" (click)="clearApiError()">{{ "biometricVerification.tryAgain" | transloco }}</button>
					<button class="btn-back-error" (click)="onBiometricsCancel()">{{ "biometricVerification.cancel" | transloco }}</button>
				</div>
			</div>
		</div>

		<div
			class="flex flex-col items-center justify-center bg-white/90 dark:bg-gray-900/90 backdrop-blur-sm transition-all duration-300 w-full h-[600px]"
			*ngIf="(response.base64Image || camera.isLoading) && !hasApiError"
			[@fadeIn]="true"
		>
			<div class="relative">
				<!-- Outer Ring -->
				<div class="absolute inset-0 rounded-full border-4 border-gray-100 dark:border-gray-800"></div>
				<!-- Spinner -->
				<mat-spinner [diameter]="80" [strokeWidth]="5"></mat-spinner>
			</div>
			<div *ngIf="response.isLoading" class="mt-10 text-xl font-medium text-gray-800 dark:text-gray-100 animate-pulse">
				{{ "biometricVerification.processingData" | transloco }}
			</div>
			<div *ngIf="camera.isLoading && !response.isLoading" class="mt-10 text-xl font-medium text-gray-600 dark:text-gray-300">
				{{ "biometricVerification.initializingCamera" | transloco }}
			</div>
		</div>

		<div class="error-container" fxLayout="column" fxLayoutAlign="center center" *ngIf="!camera.isLoading && camera.isLowQuality && !hasApiError">
			<mat-icon class="camera-error-icon" [svgIcon]="'heroicons_outline:camera'"></mat-icon>
			<h2 class="error-title">{{ "biometricVerification.cameraNotAvailable" | transloco }}</h2>
			<p class="error-description">{{ "biometricVerification.cameraAccessible" | transloco }}</p>
		</div>

		<div
			class="permission-container"
			fxLayout="column"
			fxLayoutAlign="center center"
			*ngIf="!camera.isLoading && !camera.hasPermissions && !hasApiError"
		>
			<mat-icon class="permission-icon" [svgIcon]="'heroicons_outline:camera'"></mat-icon>
			<h2 class="permission-title">{{ "biometricVerification.permissionRequired" | transloco }}</h2>
			<p class="permission-description">{{ "biometricVerification.allowAccess" | transloco }}</p>
			<button class="btn-retry" (click)="onBiometricsCancel()">{{ "biometricVerification.cancel" | transloco }}</button>
		</div>
	</div>
</div>
