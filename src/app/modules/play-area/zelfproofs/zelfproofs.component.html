<div class="flex flex-col w-full p-6 sm:p-8">
	<!-- Header -->
	<div class="flex items-center justify-between mb-8">
		<div>
			<h1 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white">ZelfProof Testing</h1>
			<p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Test HTTP 402 payment flow with ZNS tokens</p>
		</div>
		<button mat-raised-button color="primary" (click)="fillSampleData()" class="ml-4">
			<mat-icon class="icon-size-5 mr-2">auto_awesome</mat-icon>
			Fill Sample Data
		</button>
	</div>

	<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
		<!-- Left Column: Encryption Form -->
		<mat-card class="shadow-lg">
			<mat-card-header>
				<mat-card-title class="flex items-center">
					<mat-icon class="mr-2">lock</mat-icon>
					Encrypt Data
				</mat-card-title>
			</mat-card-header>
			<mat-card-content>
				<form [formGroup]="encryptForm" class="space-y-4 mt-4">
					<!-- Public Data -->
					<mat-form-field class="w-full" appearance="outline">
						<mat-label>Public Data (JSON)</mat-label>
						<textarea matInput formControlName="publicData" rows="4" placeholder='{"name": "John Doe"}'></textarea>
						<mat-hint>Enter valid JSON data to encrypt</mat-hint>
					</mat-form-field>

					<!-- Face Base64 -->
					<mat-form-field class="w-full" appearance="outline">
						<mat-label>Face Base64</mat-label>
						<textarea matInput formControlName="faceBase64" rows="3" placeholder="data:image/jpeg;base64,..."></textarea>
						<mat-hint>Base64 encoded face image</mat-hint>
					</mat-form-field>

					<!-- OS -->
					<mat-form-field class="w-full" appearance="outline">
						<mat-label>Operating System</mat-label>
						<mat-select formControlName="os">
							<mat-option value="DESKTOP">Desktop</mat-option>
							<mat-option value="ANDROID">Android</mat-option>
							<mat-option value="IOS">iOS</mat-option>
						</mat-select>
					</mat-form-field>

					<!-- Liveness Level -->
					<mat-form-field class="w-full" appearance="outline">
						<mat-label>Liveness Level</mat-label>
						<mat-select formControlName="livenessLevel">
							<mat-option *ngFor="let level of livenessLevels" [value]="level.value">
								{{ level.label }}
							</mat-option>
						</mat-select>
						<mat-hint>Select required liveness tolerance</mat-hint>
					</mat-form-field>

					<!-- Metadata -->
					<mat-form-field class="w-full" appearance="outline">
						<mat-label>Metadata (JSON)</mat-label>
						<textarea matInput formControlName="metadata" rows="3" placeholder='{"device": "Browser"}'></textarea>
						<mat-hint>Optional metadata</mat-hint>
					</mat-form-field>

					<!-- Submit Button -->
					<button mat-raised-button color="primary" class="w-full py-3" (click)="testEncrypt()" [disabled]="loading || encryptForm.invalid">
						<ng-container *ngIf="loading">
							<mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
							Processing...
						</ng-container>
						<ng-container *ngIf="!loading">
							<mat-icon class="mr-2">send</mat-icon>
							Test Encrypt
						</ng-container>
					</button>
				</form>
			</mat-card-content>
		</mat-card>

		<!-- Right Column: Payment & Response -->
		<div class="space-y-6">
			<!-- Payment Required Card -->
			@if (paymentRequired && paymentDetails) {
				<mat-card class="shadow-lg border-2 border-orange-500">
					<mat-card-header class="bg-orange-50 dark:bg-orange-900/20 -m-4 mb-4 p-4">
						<mat-card-title class="flex items-center text-orange-700 dark:text-orange-400">
							<mat-icon class="mr-2">payment</mat-icon>
							Payment Required (HTTP 402)
						</mat-card-title>
					</mat-card-header>
					<mat-card-content class="space-y-4">
						<!-- Payment Details -->
						<div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
							<h3 class="font-semibold mb-2">Payment Details:</h3>
							<div class="space-y-2 text-sm">
								<div class="flex justify-between items-center">
									<span class="text-gray-600 dark:text-gray-400">Cost:</span>
									<span class="font-mono font-bold text-lg text-primary-600">{{ paymentDetails.paymentDetails?.cost }} ZNS</span>
								</div>
								<div class="flex justify-between items-center">
									<span class="text-gray-600 dark:text-gray-400">Token:</span>
									<span class="font-mono">{{ paymentDetails.paymentDetails?.token }}</span>
								</div>
								<div class="flex justify-between items-center">
									<span class="text-gray-600 dark:text-gray-400">Chain:</span>
									<span
										class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200"
									>
										<mat-icon class="icon-size-3 mr-1">link</mat-icon>
										Solana
									</span>
								</div>
							</div>
						</div>

						<!-- Payment Action -->
						<div class="space-y-3">
							@if (!showPasswordStep) {
								<div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
									<h3 class="font-semibold mb-1 text-blue-900 dark:text-blue-300">Fast Payment</h3>
									<p class="text-xs text-blue-800 dark:text-blue-200 mb-3">
										Pay securely with your ZNS tokens. The transaction will be signed automatically after biometric verification.
									</p>

									<button
										mat-raised-button
										color="primary"
										class="w-full py-3 text-lg"
										(click)="startPaymentFlow()"
										[disabled]="paymentProcessing"
									>
										<div class="flex items-center justify-center">
											<mat-icon class="mr-2">fingerprint</mat-icon>
											Pay with ZNS
										</div>
									</button>
									<p class="text-[10px] text-center mt-2 text-gray-500">Gas fees are covered by the service (Fee Payer)</p>
								</div>
							} @else {
								<!-- Password Step -->
								<div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 animate-fade-in">
									<h3 class="font-semibold mb-4 text-gray-900 dark:text-white">Verify Identity</h3>

									<!-- Passkey Option -->
									@if (hasPasskey) {
										<div class="mb-4">
											<button
												type="button"
												(click)="onPasskeyLogin()"
												[disabled]="paymentProcessing"
												class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-xl font-semibold hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors border border-blue-200 dark:border-blue-800"
											>
												@if (paymentProcessing) {
													<mat-spinner diameter="20" class="mr-2"></mat-spinner>
												} @else {
													<mat-icon class="icon-size-5">fingerprint</mat-icon>
												}
												Continue with Passkey
											</button>
											<div class="mt-3 flex items-center gap-3">
												<div class="h-px bg-gray-200 dark:bg-gray-700 flex-1"></div>
												<span class="text-[10px] font-medium text-gray-400 uppercase">OR USE PASSWORD</span>
												<div class="h-px bg-gray-200 dark:bg-gray-700 flex-1"></div>
											</div>
										</div>
									}

									<!-- Password Form -->
									<div class="space-y-3">
										<div class="space-y-1">
											<label class="text-xs font-semibold text-gray-700 dark:text-gray-300 ml-1">Master Password</label>
											<div
												class="flex items-center w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl px-3 focus-within:border-blue-500 transition-colors"
											>
												<mat-icon class="text-gray-400 icon-size-5 mr-2">lock</mat-icon>
												<input
													[(ngModel)]="masterPassword"
													[type]="showPassword ? 'text' : 'password'"
													class="flex-1 bg-transparent border-none focus:ring-0 text-gray-900 dark:text-white py-2.5 text-sm font-medium placeholder-gray-400 focus:outline-none"
													placeholder="Enter password to sign"
													[disabled]="paymentProcessing"
												/>
												<button
													type="button"
													(click)="togglePasswordVisibility()"
													class="text-gray-400 hover:text-gray-600 transition-colors ml-2"
												>
													<mat-icon class="icon-size-5">{{ showPassword ? "visibility_off" : "visibility" }}</mat-icon>
												</button>
											</div>
										</div>

										<div class="flex gap-2 pt-2">
											<button
												type="button"
												(click)="cancelPaymentFlow()"
												class="flex-1 px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
												[disabled]="paymentProcessing"
											>
												Cancel
											</button>
											<button
												type="button"
												(click)="proceedToBiometric()"
												[disabled]="!masterPassword || paymentProcessing"
												class="flex-1 px-3 py-2 rounded-xl bg-primary-600 text-white text-sm font-bold hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-sm"
											>
												Continue
											</button>
										</div>
									</div>
								</div>
							}

							<!-- Manual Fallback -->
							<div class="border-t border-gray-200 dark:border-gray-700 pt-3 mt-4">
								<p class="text-xs text-center text-gray-500 mb-3">Or verify manually</p>
								<div class="flex gap-2">
									<mat-form-field class="w-full text-xs" density="dense" subscriptSizing="dynamic">
										<mat-label>Transaction Hash</mat-label>
										<input matInput [(ngModel)]="paymentTxHash" placeholder="Tx Hash" />
									</mat-form-field>
									<button
										mat-icon-button
										color="primary"
										(click)="testEncrypt()"
										[disabled]="!paymentTxHash"
										matTooltip="Verify Payment"
									>
										<mat-icon>check_circle</mat-icon>
									</button>
								</div>
							</div>
						</div>
					</mat-card-content>
				</mat-card>
			}

			<!-- Success Response Card -->
			@if (response) {
				<mat-card class="shadow-lg border-2 border-green-500">
					<mat-card-header class="bg-green-50 dark:bg-green-900/20 -m-4 mb-4 p-4">
						<mat-card-title class="flex items-center text-green-700 dark:text-green-400">
							<mat-icon class="mr-2">check_circle</mat-icon>
							Success
						</mat-card-title>
					</mat-card-header>
					<mat-card-content>
						<div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
							<div class="flex items-center justify-between mb-2">
								<h3 class="font-semibold">Response:</h3>
								<button mat-icon-button (click)="copyResponseToClipboard()">
									<mat-icon>content_copy</mat-icon>
								</button>
							</div>
							<pre class="text-xs overflow-auto max-h-96 bg-white dark:bg-gray-900 p-3 rounded">{{ response | json }}</pre>
						</div>
					</mat-card-content>
				</mat-card>
			}

			<!-- Error Card -->
			@if (error) {
				<mat-card class="shadow-lg border-2 border-red-500">
					<mat-card-header class="bg-red-50 dark:bg-red-900/20 -m-4 mb-4 p-4">
						<mat-card-title class="flex items-center text-red-700 dark:text-red-400">
							<mat-icon class="mr-2">error</mat-icon>
							Error
						</mat-card-title>
					</mat-card-header>
					<mat-card-content>
						<div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
							<pre class="text-xs overflow-auto max-h-96 text-red-600 dark:text-red-400">{{ error | json }}</pre>
						</div>
					</mat-card-content>
				</mat-card>
			}

			<!-- Info Card -->
			@if (!paymentRequired && !response && !error) {
				<mat-card class="shadow-lg">
					<mat-card-header>
						<mat-card-title class="flex items-center">
							<mat-icon class="mr-2">info</mat-icon>
							How it works
						</mat-card-title>
					</mat-card-header>
					<mat-card-content class="space-y-3 text-sm">
						<p><strong>Step 1:</strong> Fill in the encryption data (or use sample data)</p>
						<p><strong>Step 2:</strong> Click "Test Encrypt" - you'll get a 402 Payment Required response</p>
						<p><strong>Step 3:</strong> Click "Pay with ZNS" to authenticate with biometrics</p>
						<p><strong>Step 4:</strong> The transaction is automatically signed and submitted</p>
						<p><strong>Step 5:</strong> Encryption succeeds with payment proof!</p>

						<div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded mt-4">
							<p class="text-xs text-blue-800 dark:text-blue-200">
								<strong>Fee Payer:</strong> You don't need SOL to pay gas fees. The service covers the transaction costs.
							</p>
						</div>
					</mat-card-content>
				</mat-card>
			}
		</div>
	</div>

	<!-- Biometric Verification Modal - Full Screen (Matches Sign In Style) -->
	@if (showBiometricModal) {
		<div
			class="fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 p-4 transition-opacity duration-300 animate-fade-in"
		>
			<div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-4xl min-h-[600px] max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
				<!-- Header -->
				<div class="px-6 py-5 flex items-center justify-between shrink-0 border-b border-gray-100 dark:border-gray-800">
					<div class="flex flex-col">
						<h2 class="text-xl font-bold text-gray-900 dark:text-white leading-tight tracking-tight">Biometric Verification</h2>
						<div class="flex items-center gap-1.5 mt-1">
							<div
								class="bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide flex items-center gap-1"
							>
								<mat-icon class="icon-size-3">lock</mat-icon>
								<span>SECURE</span>
							</div>
							<span class="text-xs font-medium text-gray-500 dark:text-gray-400"> Payment Authorization </span>
						</div>
					</div>
					<button
						mat-icon-button
						(click)="onBiometricCancel()"
						class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 rounded-full transition-colors"
					>
						<mat-icon class="icon-size-4 text-gray-500 dark:text-gray-400">close</mat-icon>
					</button>
				</div>

				<div class="p-0 pt-4 pb-8 overflow-y-auto flex-1 flex flex-col justify-center items-center w-full relative">
					<!-- Biometric Component -->
					<app-data-biometrics
						class="w-full h-full flex flex-col items-center justify-center"
						[userData]="{
							domain: 'payment',
							masterPassword: masterPassword,
						}"
						[isModalContext]="true"
						(biometricsSuccess)="onBiometricSuccess($event)"
						(biometricsCancel)="onBiometricCancel()"
					></app-data-biometrics>
				</div>
			</div>
		</div>
	}
</div>
