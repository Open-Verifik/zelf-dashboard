import{a as f}from"./chunk-E6ENPQNB.js";import{w as S}from"./chunk-53Z5H5E5.js";import{aa as w,ga as b,p as d}from"./chunk-3HE7R7QB.js";import{a as h,b as g,g as o}from"./chunk-TSRGIXR5.js";var R=(()=>{class l{constructor(){this.STORAGE_KEY="zelf_passkeys",this._httpClient=b(S)}isSupported(){return o(this,null,function*(){return!!window.PublicKeyCredential})}register(e){return o(this,null,function*(){try{let t=crypto.getRandomValues(new Uint8Array(32)),s=crypto.getRandomValues(new Uint8Array(16)),r=crypto.getRandomValues(new Uint8Array(32)),n={publicKey:{challenge:t,rp:{name:"Zelf Dashboard",id:window.location.hostname},user:{id:s,name:e,displayName:e},pubKeyCredParams:[{alg:-7,type:"public-key"},{alg:-257,type:"public-key"}],timeout:6e4,authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required",residentKey:"required"},extensions:{prf:{eval:{first:r}}}}},a=yield navigator.credentials.create(n);if(!a)return null;let c=a.getClientExtensionResults(),p;if(c.prf&&c.prf.results&&c.prf.results.first)p=new Uint8Array(c.prf.results.first);else{console.warn("PRF extension not supported or enabled. falling back to HKDF using Credential ID.");let m=new TextEncoder().encode(a.id);p=new Uint8Array(32);for(let y=0;y<32;y++)p[y]=m[y%m.length]^r[y%r.length]}let u=yield this.importKey(p);return{credentialId:a.id,key:u,salt:r}}catch(t){return console.error("Error creating passkey:",t),null}})}authenticate(e,t){return o(this,null,function*(){try{let r={publicKey:{challenge:crypto.getRandomValues(new Uint8Array(32)),timeout:6e4,userVerification:"required",allowCredentials:[{id:this.base64UrlToBuffer(e),type:"public-key"}],extensions:{prf:{eval:{first:t}}}}},n=yield navigator.credentials.get(r);if(!n)return null;let a=n.getClientExtensionResults(),c;if(a.prf&&a.prf.results&&a.prf.results.first)c=new Uint8Array(a.prf.results.first);else{console.warn("PRF extension not supported in Auth. Using fallback derivation.");let u=new TextEncoder().encode(n.id);c=new Uint8Array(32);for(let i=0;i<32;i++)c[i]=u[i%u.length]^t[i%t.length]}return yield this.importKey(c)}catch(s){return console.error("Error authenticating passkey:",s),null}})}encryptPassword(e,t){return o(this,null,function*(){let s=crypto.getRandomValues(new Uint8Array(12)),r=new TextEncoder().encode(e),n=yield crypto.subtle.encrypt({name:"AES-GCM",iv:s},t,r);return{ciphertext:this.bufferToBase64(n),iv:this.bufferToBase64(s)}})}decryptPassword(e,t,s){return o(this,null,function*(){let r=this.base64ToBuffer(t),n=this.base64ToBuffer(e),a=yield crypto.subtle.decrypt({name:"AES-GCM",iv:r},s,n);return new TextDecoder().decode(a)})}savePasskeyMetadata(e,t){return o(this,null,function*(){let s=this.getStore();s[e]=g(h({},t),{synced:!1}),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s));try{let r=e.includes("@"),n={passkey:t};r?n.email=e:n.phone=e,yield d(this._httpClient.post(`${f.apiUrl}/api/staff/passkeys`,n));let a=this.getStore();a[e]&&(a[e].synced=!0,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a)))}catch(r){console.error("Failed to sync passkey to cloud:",r)}})}getPasskeyMetadata(e){return o(this,null,function*(){let t=this.getStore();if(t[e])return t[e];try{let s=yield d(this._httpClient.get(`${f.apiUrl}/api/staff/passkeys?identifier=${encodeURIComponent(e)}`));if(s&&s.data){let r=s.data,n=this.getStore();return n[e]=g(h({},r),{synced:!0}),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n)),r}}catch{}return null})}deletePasskeyMetadata(e){return o(this,null,function*(){let t=this.getStore();t[e]&&(delete t[e],localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)));try{let s=e.includes("@"),r={identifier:e};s?r.email=e:r.phone=e,yield d(this._httpClient.delete(`${f.apiUrl}/api/staff/passkeys`,{body:r}))}catch(s){console.error("Failed to delete passkey from cloud:",s)}})}getStore(){try{return JSON.parse(localStorage.getItem(this.STORAGE_KEY)||"{}")}catch{return{}}}importKey(e){return o(this,null,function*(){return yield crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"])})}bufferToBase64(e){let t=new Uint8Array(e),s="";for(let r=0;r<t.byteLength;r++)s+=String.fromCharCode(t[r]);return btoa(s)}base64ToBuffer(e){let t=atob(e),s=new Uint8Array(t.length);for(let r=0;r<t.length;r++)s[r]=t.charCodeAt(r);return s}base64UrlToBuffer(e){let t=e.replace(/-/g,"+").replace(/_/g,"/"),s=t.length%4,r=s?t+"=".repeat(4-s):t;return this.base64ToBuffer(r)}static{this.\u0275fac=function(t){return new(t||l)}}static{this.\u0275prov=w({token:l,factory:l.\u0275fac,providedIn:"root"})}}return l})();export{R as a};
